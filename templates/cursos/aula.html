{% extends 'base.html' %}
{% load static %}

{% block title %}{{ aula.titulo }} - Aula{% endblock %}

{% block content %}
<div class="container mt-4">
  <h2 class="mb-3">{{ aula.titulo }}</h2>

  <!-- BARRA DE PROGRESSO -->
  {% if total_aulas and aulas_concluidas %}
    {% with progresso_percent=aulas_concluidas|divisibleby:total_aulas|floatformat:0 %}
      <div class="mb-4">
        <label for="progressoCurso"><strong>Progresso do Curso: {{ aulas_concluidas }}/{{ total_aulas }} aulas conclu√≠das</strong></label>
        <div class="progress">
          <div class="progress-bar bg-success" role="progressbar"
               style="width:{{ progresso_percent }}%"
               aria-valuenow="{{ progresso_percent }}" aria-valuemin="0" aria-valuemax="100">
            {{ progresso_percent }}%
          </div>
        </div>
      </div>
    {% endwith %}
  {% endif %}

  <!-- V√çDEO -->
  {% if aula.video_url %}
    <div class="ratio ratio-16x9 mb-4">
      <iframe
        src="{{ aula.video_url|replace:'watch?v=','embed/' }}"
        title="V√≠deo da Aula"
        frameborder="0"
        allowfullscreen
      ></iframe>
    </div>
  {% endif %}

  <!-- CONTE√öDO TEXTO -->
  {% if aula.texto %}
    <div class="card mb-4">
      <div class="card-body">
        {{ aula.texto|linebreaks }}
      </div>
    </div>
  {% endif %}

  <!-- ARQUIVO -->
  {% if aula.arquivo %}
    <div class="mb-4">
      <a href="{{ aula.arquivo.url }}" class="btn btn-outline-primary" download>
        üì• Baixar Material Complementar (PDF)
      </a>
    </div>
  {% endif %}

  <!-- CONCLUS√ÉO -->
  <div class="mb-4">
    {% if progresso.concluido %}
      <p class="text-success"><strong>‚úÖ Aula conclu√≠da</strong></p>
    {% else %}
      <a href="{% url 'cursos:concluir_aula' aula.id %}" class="btn btn-success">
        ‚úÖ Marcar como Conclu√≠da
      </a>
    {% endif %}
  </div>

  <!-- QUIZ -->
  {% if aula.tem_questionario %}
    <div class="mb-4">
      <a href="{% url 'cursos:questionario' aula.id %}" class="btn btn-primary">
        üìù Ir para o Question√°rio da Aula
      </a>
    </div>
  {% endif %}

  <!-- PR√ìXIMA AULA -->
  {% if proxima_aula %}
    <div class="mt-4">
      <a href="{% url 'cursos:exibir_aula' proxima_aula.id %}" class="btn btn-outline-success">
        ‚è≠Ô∏è Ir para a Pr√≥xima Aula: {{ proxima_aula.titulo }}
      </a>
    </div>
  {% endif %}

  <!-- COMENT√ÅRIOS -->
  <hr>
  <div class="mt-5">
    <h4>üí¨ Coment√°rios da Aula</h4>

    {% for comentario in comentarios %}
      <div class="border p-2 mb-2 rounded bg-light">
        <strong>{{ comentario.usuario.get_full_name }}</strong>
        <small class="text-muted float-end">{{ comentario.data|date:"d/m/Y H:i" }}</small>
        <p class="mb-1">{{ comentario.texto|linebreaks }}</p>
      </div>
    {% empty %}
      <p class="text-muted">Nenhum coment√°rio ainda. Seja o primeiro!</p>
    {% endfor %}

    {% if user.is_authenticated %}
      <form method="POST" class="mt-3">
        {% csrf_token %}
        <div class="mb-3">
          <textarea name="comentario" class="form-control" rows="3" placeholder="Digite seu coment√°rio..." required></textarea>
        </div>
        <button type="submit" class="btn btn-primary">üí¨ Enviar Coment√°rio</button>
      </form>
    {% else %}
      <p><a href="{% url 'usuarios:login' %}">Fa√ßa login</a> para comentar.</p>
    {% endif %}
  </div>

  <!-- VOLTAR -->
  <div class="mt-5">
    <a href="{% url 'usuarios:painel' %}" class="btn btn-secondary">‚¨Ö Voltar ao Painel</a>
  </div>
</div>
{% endblock %}
